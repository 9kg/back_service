$(function(){function t(t,e){var n=$("th:first-child"),i=$('[name="sel_task"]:checked').map(function(){return $(this).val()}).get().join();if(!i)return n.operTip("请勾选您要"+t+"的任务！",{theme:"primary",dir:"right"}),!1;var s,r;o.content="function"===$.type(e)?"您确认要导出id为("+i+")的任务的IDFA？":"您确认要"+t+"id为("+i+")的任务？",o.alertfn=function(t){if(t){if("number"===$.type(e))r="modify",s={id:i,power:e};else{if("function"===$.type(e))return e(i),!0;"undefined"===$.type(e)&&(r="remove",s={id:i})}$.ajax({url:"http://es2.laizhuan.com/back/task/"+r,type:"POST",dataType:"json",data:s}).done(function(t){var e=$(".table_filter");1==t.status?(e.operTip(t&&t.msg||"操作成功！",{theme:"success",css:{"white-space":"nowrap"}}),a.render()):e.operTip(t&&t.msg||"操作失败！",{theme:"danger",css:{"white-space":"nowrap"}})}).fail(function(t){console.dir(t)})}},o.init(),o.show()}var e,n={$ct:$(".content"),pageSizes:[10,25,50,100,200],theme:"warning",footerFix:!0,url:"http://es2.laizhuan.com/back/task/query",sendData:{page_size:25,filter_key:"name",sort:"id",sort_dir:"desc",cur_page:1,status:-1},col:[{key:"id",title:'<label class="checkbox"><input type="checkbox" name="sel_task_all"><span class="opt_imitate"></span></label>',width:20,render:function(t,e){var n=$('<label class="checkbox"><input type="checkbox" value="'+e+'" name="sel_task"><span class="opt_imitate"></span></label>');t.append(n)}},{key:"id",title:"ID",filter:!0,sort:!0,cls:"hidden_xs"},{key:"pname",title:"商务",sort:!0,filter:!0,cls:"hidden_md"},{key:"company",title:"公司",sort:!0,filter:!0,cls:"hidden_md"},{key:"name",title:"名称",sort:!0,filter:!0,render:function(t,e){e&&t.text(e.slice(0,15)+(e.length>15?"...":""))}},{key:"keyword",title:"关键词",sort:!0,filter:!0,cls:"hidden_xs"},{key:"iscomment",title:"评论",sort:!0,cls:"hidden_xs"},{key:"countall",title:"投放",sort:!0},{key:"num_finish",title:"已完成",sort:!0,cls:"hidden_xs"},{key:"stime",title:"开始时间",sort:!0},{key:"adTemp",title:"来源",sort:!0,filter:!0,cls:"hidden_xs",render:function(t,e,n,a){t.html(e+"("+a.source_id+")")}},{key:"taskprice",title:"单价",sort:!0,filter:!0,cls:"hidden_xs"},{key:"id",title:"操作",width:60,cls:"t_center",render:function(t,e,n,a){var i=+$('[name="status"]:checked').val(),o='<button type="button" class="btn btn_info btn_query_detail">查看</button>';o+='<button type="button" class="btn btn_primary btn_copy">续单</button>',o+=1>i?'<button type="button" class="btn btn_warning btn_modify">修改</button>':'<button type="button" class="btn btn_warning btn_idfa">标示</button>',t.html($(o)),t.data("row_data",a)}}]},a=new Table(n),i=new Box({title:"idfa记录",html:'<div class="idfa_list"></div>',css:{"min-width":"320px"},footer:!1});$("body").on("click","table .btn_query_detail",function(){var t=$(this).closest("td").data("row_data").id;window.open("http://es2.laizhuan.com/back/page/task_detail/"+t)}).on("click","tbody tr",function(t){$(t.target).is('.btn,.opt_imitate,[type="checkbox"]')||$(this).find('[type="checkbox"]').trigger("click")}).on("click",'[name="status"]',function(){var t=+$(this).val();$(".btn_delete").toggleClass("hidden",t>-1),$(".btn_agree,.btn_disagree").toggleClass("hidden",-1!==t),$(".btn_pause").toggleClass("hidden",1!==t),$(".btn_start").toggleClass("hidden",2!==t),$(".btn_stop").toggleClass("hidden",1!==t&&2!==t),$(".btn_export").toggleClass("hidden",1>t),a.sendData.status=t,a.sendData.cur_page=1;var e={"-2":"gray","-1":"warning",1:"info",2:"magenta",8:"danger",9:"success"};a.theme=e[t],a.render()}).on("click","table .btn_modify",function(){var t=$(this).closest("td").data("row_data");oper_task.box.initHeader("修改任务"),oper_task.box.operType="modify",oper_task.box.initContent("http://es2.laizhuan.com/back/page/task_add .add_task_form",function(){oper_task.box.show(),oper_task.initWidget(),$("form.add_task .show_by_edit").removeClass("hidden").find("input").prop("disabled",!1),window.oper_task.renderTaskForm(t)});var e=$(this).parent();oper_task.box.afterfnSure=function(t,n){t?(e.operTip(n||"操作成功！",{theme:"warning",css:{"white-space":"nowrap"}}),a.render()):e.operTip(n||"操作失败！",{theme:"danger",css:{"white-space":"nowrap"}})}}).on("click",".btn_add",function(){oper_task.box.initHeader("添加任务"),oper_task.box.operType="insert",oper_task.box.initContent("http://es2.laizhuan.com/back/page/task_add .add_task_form",function(){oper_task.box.show(),oper_task.initWidget()});var t=$(this).parent();oper_task.box.afterfnSure=function(e,n){e?(t.operTip(n||"操作成功！",{theme:"warning",css:{"white-space":"nowrap"}}),a.render()):t.operTip(n||"操作失败！",{theme:"danger",css:{"white-space":"nowrap"}})}}).on("click",".btn_copy",function(){var t=$(this).closest("td").data("row_data");oper_task.box.initHeader("任务续单"),oper_task.box.operType="insert",oper_task.box.initContent("http://es2.laizhuan.com/back/page/task_add .add_task_form",function(){oper_task.box.show(),oper_task.initWidget(),window.oper_task.renderTaskForm(t)});var e=$(this).parent();oper_task.box.afterfnSure=function(t,n){t?(e.operTip(n||"操作成功！",{theme:"warning",css:{"white-space":"nowrap"}}),a.render()):e.operTip(n||"操作失败！",{theme:"danger",css:{"white-space":"nowrap"}})}}).on("click",".btn_idfa",function(){var t=$(this).closest("td").data("row_data").id;i.show();var n={$ct:$(".idfa_list"),col:[{key:"task_end",title:"完成时间",sort:!0,filter:!0},{key:"idfa",title:"IDFA",sort:!0,filter:!0},{key:"ip",title:"IP",sort:!0,filter:!0,cls:"hidden_xs"}],theme:"lightblue",sendData:{id:t},url:"http://es2.laizhuan.com/back/task/idfa_query"};$(".idfa_list .table").length?(e.sendData.id=t,e.render()):e=new Table(n)}).on("click",".btn_agree",function(){t("同意",1)}).on("click",".btn_export",function(){t("导出IDFA",function(t){window.open("http://es2.laizhuan.com/admin/idfaExcelMore?id="+t+"&token=e43151e1643ec65786c1ea6097497a4e"),$('[name="sel_task"]').prop("checked",!1)})}).on("click",".btn_disagree",function(){t("拒绝",-2)}).on("click",".btn_pause",function(){t("暂停",2)}).on("click",".btn_start",function(){t("开始",1)}).on("click",".btn_stop",function(){t("终止",8)}).on("click",".btn_delete",function(){t("删除")});var o=new Tip({$ct:$(".btn_batch_ct"),confirm:!0,isShow:!1,theme:"warning",css:{"word-break":"break-word"}})});