$(function(){function renderChart(){var t=$('[name="chart_name"]:checked').val(),a=chart_type_obj[t];chart_opt.yAxis[0].name=a;var e=chart_opt.xAxis[0].data;chart_opt.title.subtext=a+"("+e[0]+"——"+e[e.length-1]+")";var r="countall"===t?"总量":"总额";chart_opt.series=$.map(data_obj,function(a,e){return{name:e,type:"line",stack:r,areaStyle:{normal:{}},data:a[t]}}),finance_chart=chart.renderChart($(".chart_container")[0],chart_opt)}function formatData(){data_obj={};var t=[],a=[];$.each(finance_data,function(e,r){var n=r.report_date,o=r.company;!~$.inArray(n,t)&&t.push(n),!~$.inArray(o,a)&&a.push(o),data_obj[o]||(data_obj[o]={fee:[],cost:[],countall:[]});var c=t.length-1;data_obj[o].fee[c]=+r.fee,data_obj[o].cost[c]=+r.cost,data_obj[o].countall[c]=+r.countall}),$.each(t,function(t,e){$.each(a,function(a,e){void 0===data_obj[e].fee[t]&&(data_obj[e].fee[t]=0,data_obj[e].cost[t]=0,data_obj[e].countall[t]=0)})}),chart_opt.xAxis[0].data=t,chart_opt.legend.data=a,renderChart()}function getData(){$.ajax({url:data_url,dataType:"json",data:{sdate:$(".date_start").val(),edate:$(".date_end").val()}}).done(function(t){1===t.status?(finance_data=t.data,renderTable(),formatData()):$tip_ct.operTip(t.msg||"获取数据失败！",{dir:"bottom",theme:"danger",css:{"white-space":"nowrap"}})}).fail(function(){$tip_ct.operTip("获取数据失败！",{dir:"bottom",theme:"danger",css:{"white-space":"nowrap"}})})}function renderTable(){finance_table?(finance_table.data=finance_data,finance_table.render()):(table_opt.data=finance_data,finance_table=new Table(table_opt))}function renderTotal(data){var fee_arr=[],cost_arr=[],countall_arr=[];$.each(data||finance_data,function(t,a){fee_arr.push(+a.fee),cost_arr.push(+a.cost),countall_arr.push(+a.countall)}),$(".total_fee").text(eval(fee_arr.join("+"))||0),$(".total_cost").text(eval(cost_arr.join("+"))||0),$(".total_countall").text(eval(countall_arr.join("+"))||0)}var $tip_ct=$(".filter_ct"),data_url="http://es2.laizhuan.com/back/finance/report",finance_data,data_obj={},chart_type_obj={fee:"销售额",cost:"成本",countall:"完成量"},start_date=base.calDate("d",-7,new Date),date_start=$(".date_start").val(base.date("y-m-d",start_date)).datepicker({timepicker:!1,max:"today",min:"2016-07-20",datetime:start_date}),date_end=$(".date_end").val(base.now("y-m-d")).datepicker({timepicker:!1,min:start_date,max:"today"}),finance_table,finance_chart,table_opt={$ct:$(".table_ct"),isLocal:!0,footerFix:!0,sendData:{page_size:20,filter_key:"company",sort:"report_date",sort_dir:"asc",cur_page:1},fnAfterLocalFilter:function(t){renderTotal(t)},col:[{key:"report_date",title:"日期",sort:!0,filter:!0},{key:"company",title:"公司",sort:!0,filter:!0},{key:"source_id",title:"来源",sort:!0,filter:!0,cls:"hidden_xs"},{key:"fee",title:"销售额",sort:!0,filter:!0},{key:"cost",title:"成本",sort:!0,filter:!0},{key:"countall",title:"完成量",sort:!0,filter:!0},{key:"pay_type",title:"支付类型",sort:!0,cls:"hidden_xs",render:function(t,a){+a?t.html("后付"):t.html("预付").addClass("warning_color")}}]},chart_opt={title:{text:"财务图表",x:"500",align:"right"},grid:{left:440,bottom:80},toolbox:{feature:{magicType:{type:["stack","tiled"]},restore:{},saveAsImage:{}}},tooltip:{trigger:"axis",axisPointer:{animation:!1}},legend:{x:"left",y:50,orient:"vertical"},xAxis:[{type:"category",boundaryGap:!1,axisLine:{onZero:!1}}],yAxis:[{type:"value"}]};getData(),$("body").on("click",".btn_toggle_table_chart",function(){$(".chart_ct,.table_ct").toggleClass("hidden"),$(".chart_ct").is(".hidden")||renderChart()}).on("change",".date_start",function(){date_end.cgOpt({min:$(this).val()}),getData()}).on("change",".date_end",function(){date_start.cgOpt({max:$(this).val()}),getData()}).on("click",'[name="chart_name"]',function(){renderChart()})});