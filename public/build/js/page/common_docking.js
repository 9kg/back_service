$(function(){function sendForm(e,t){var a=e.find('[name="id"]'),n=e.serializeArray(),i=[{name:"oper_type",value:"insert"}];a.length&&(i[0].value="update",i.push({name:"id",value:a.val()})),$.ajax({type:"POST",url:operUrl,dataType:"json",data:i.concat(n)}).done(function(e){if(1==e.status){var t=!0,i=a.val();i?t=!1:i=e.id,updateData(n,i,t)}else $(".opers").operTip(e.msg||"操作出现异常！",{theme:"danger"})}).fail(function(){$(".opers").operTip("添加失败！",{theme:"danger",css:{"white-space":"nowrap"}})}).always(function(){t.hide()})}function paddingData(e){e.source_name=source_data[e.source]||"关联来源失败("+(e.source||"")+")",e.unique_url=(e.unique_req_url||"无")+relateParam(e.unique_param_key,e.unique_param_val),e.click_url=(e.click_req_url||"无")+relateParam(e.click_param_key,e.click_param_val),e.active_url=(e.active_req_url||"无")+relateParam(e.active_param_key,e.active_param_val)}function updateData(form_cnt,id,isAdd){if(void 0===id)$(".opers").operTip("操作异常！",{theme:"danger",css:{"white-space":"nowrap"}});else{var new_item={id:id};$.each(form_cnt,function(i,item){var _key=item.name,_val=item.value;if(~_key.indexOf("_param_key[")||~_key.indexOf("_param_val[")){var _k='new_item["'+_key.slice(0,_key.indexOf("["))+'"]';eval("!"+_k+" ? ("+_k+'=["'+_val+'"]) : '+_k+'.push("'+_val+'")')}else new_item[_key]=_val}),paddingData(new_item),isAdd?table.data.push(new_item):$.each(table.data,function(e,t){return t.id==id?(table.data[e]=new_item,!1):void 0}),table.renderData(),$(".opers").operTip("操作成功！",{theme:"success",css:{"white-space":"nowrap"}})}}function relateParam(e,t){var a="";return e&&e.length&&$.each(e,function(e,n){if(""===n)return!0;var i=t[e];getSysOptName(i)&&(i="{"+i+"}"),a+="&"+n+"="+i}),a=a.length>1?"?"+a.slice(1):""}function remove_docking_item(e,t){$.ajax({type:"POST",url:operUrl,dataType:"json",data:{oper_type:"delete",id:e}}).done(function(e){e&&1===e.status?$(".table_filter").operTip("删除成功！",{dir:"bottom",theme:"success",timeout:5e3,css:{"white-space":"nowrap"}}):$(".table_filter").operTip(e&&e.msg||"删除响应异常",{dir:"bottom",theme:"danger",timeout:5e3,css:{"white-space":"nowrap"}})}).fail(function(){$td.operTip("删除失败！",{dir:"bottom",theme:"danger",timeout:5e3,css:{"white-space":"nowrap"}})}).always(function(){t&&t(),sourceMask.hide()})}function trigger_plus(e,t){if(t)for(var a=0;t>a;a++)e.trigger("click")}function renderForm(e){base.renderOption($("#source"),source_data,["id","name"]);var t;$.each(table.data,function(a,n){return n.id==e?(t=n,!1):void 0}),$(".source_ct").suggest({key:"id",val:"name",$key_ct:$('[name="source"]'),$val_ct:$(".source_name"),data:source_data}),$(".docking_edit .source_name").val(source_data[t.source]),base.requireChild($(".docking_edit")),trigger_plus($(".unique_docking_content .icon_plus"),t.unique_param_key&&t.unique_param_key.length),trigger_plus($(".click_docking_content .icon_plus"),t.click_param_key&&t.click_param_key.length),trigger_plus($(".active_docking_content .icon_plus"),t.active_param_key&&t.active_param_key.length),$('[name][type="checkbox"]',$(".docking_edit")).prop("checked",!1).trigger("change"),base.renderForm($(".docking_edit"),t,function(e){"unique_md5_val"===e&&void 0!==t[e]?$('[data-show=".unique_md5_content"]').prop("checked",!0).trigger("change"):"click_md5_val"===e&&void 0!==t[e]?$('[data-show=".click_md5_content"]').prop("checked",!0).trigger("change"):"active_md5_val"===e&&void 0!==t[e]&&$('[data-show=".active_md5_content"]').prop("checked",!0).trigger("change")},function(e,t,a){~$.inArray(a,["unique_param_val","click_param_val","active_param_val"])&&(getSysOptName(t)?$('input[name="'+a+"["+e+']"]').val(""):($('[name="'+a+"["+e+']"]').closest(".param_item").find("select").eq(0).val("preset").trigger("change"),$('select[name="'+a+"["+e+']"]').val("idfa")))})}function renderUrl(e){var t=$('[name$="_req_url"]',e),a=$('[name*="_param_key"]',e).map(function(){return $(this).val()}),n=$('[name*="_param_val"]:not(:disabled)',e).map(function(){return $(this).val()});$(".url_all",e).html(t.val()+relateParam(a,n))}function getSysOptName(e){var t;return $.each(systemOpts,function(a,n){return n.key===e?(t=n.val,!1):void 0}),t}function testDocking(e,t,a){var n={module:"test_interface",id:e,action:t};"unique"!==t?sendTestDocking(n,a):(box_idfa.sendData=n,box_idfa.$td=a,box_idfa.show())}function sendTestDocking(e,t){var a=new Mask({$ct:t,content:"接口测试中！"});$.ajax({url:operUrl,dataType:"json",data:e}).done(function(e){console.dir(e),e&&1===e.status?t.operTip("成功",{dir:"bottom",theme:"success",timeout:5e3}):t.operTip(e&&e.msg||"返回数据异常",{dir:"bottom",theme:"danger",timeout:5e3})}).fail(function(){t.operTip("获取来源信息失败",{dir:"bottom",theme:"danger",timeout:5e3})}).always(function(){a.hide()})}var operUrl="http://es2.laizhuan.com/module/interface/index.php",systemOpts=[{key:"idfa",val:"IDFA"},{key:"appid",val:"AppID"},{key:"ip",val:"IP"},{key:"dver",val:"设备版本"},{key:"time",val:"时间戳"},{key:"md5",val:"MD5"},{key:"callback",val:"回调"}],sourceMask=new Mask({$ct:$(".content"),content:"来源数据加载中！"}),source_data={};$.ajax({async:!1,url:"http://es2.laizhuan.com/back/source/query",dataType:"json"}).done(function(e){e&&1===e.status?$.each(e.data,function(e,t){source_data[t.id]=t.name}):$(".opers").operTip(e&&e.msg||"来源数据异常",{dir:"bottom",theme:"danger",timeout:5e3,css:{"white-space":"nowrap"}})}).fail(function(){$(".opers").operTip("获取来源信息失败",{dir:"bottom",theme:"danger",timeout:5e3,css:{"white-space":"nowrap"}})}).always(function(){sourceMask.hide()});var opt={$ct:$(".docking_list"),col:[{key:"id",title:"ID",show:!1},{key:"app_id",title:"APP ID",sort:!0,filter:!0},{key:"app_name",title:"名称",sort:!0,filter:!0},{key:"source_name",title:"来源",sort:!0,filter:!0},{key:"unique_url",title:"排重接口",sort:!0,cls:"hidden_xs",filter:!0,render:function(e,t,a,n){var i=n.unique_req_url?'<i class="iconfont icon-8a4 icon_test" data-type="unique"></i>':"";$(e).html(t+i)}},{key:"click_url",title:"点击上报",sort:!0,cls:"hidden_xs",filter:!0,render:function(e,t,a,n){var i=n.click_req_url?'<i class="iconfont icon-8a4 icon_test" data-type="click"></i>':"";$(e).html(t+i)}},{key:"active_url",title:"激活上报",sort:!0,cls:"hidden_xs",filter:!0,render:function(e,t,a,n){var i=n.active_req_url?'<i class="iconfont icon-8a4 icon_test" data-type="active"></i>':"";$(e).html(t+i)}},{key:"id",title:"操作",cls:"text_center",render:function(e,t,a,n){$(a).data("data-obj",n);var i=$('<div class="table_btns"><button class="btn btn_info btn_search" type="button">查看</button><button class="btn btn_primary btn_renew" type="button">续单</button></div><div class="table_btns"><button class="btn btn_warning btn_edit" type="button">修改</button><button class="btn btn_danger btn_remove" type="button">删除</button></div>');$(e).html(i)}}],isLocal:!0,url:operUrl,fnAfterData:function(e){return e&&e.data&&e.data.length?void $.each(e.data,function(e,t){paddingData(t)}):!1}},table=new Table(opt),box_docking=new Box({title:"接口",html:"http://es2.laizhuan.com/back/page/docking_add .docking_form",fnSure:function(e){var t=$(".docking_edit");if(t.is(".readonly"))e.hide();else{if(!base.formValidate(t))return!1;sendForm(t,e)}return!1},fnCancel:function(e){},css:{"min-width":"300px"}}),box_idfa=new Box({title:"idfa",html:'<input type="text" class="test_dock_idfa">',fnSure:function(e){e.sendData.idfa=e.$el.find(".test_dock_idfa").val(),sendTestDocking(e.sendData,e.$td)},fnCancel:function(e){},css:{"min-width":"300px"}});$(".content").on("click",".btn_remove",function(){var e=$(this).closest("tr").data("data-obj").id;new Tip({$ct:$(this).closest("td"),content:"确认删除？",confirm:!0,css:{"white-space":"nowrap"},theme:"warning",dir:"left",alertfn:function(t){t&&remove_docking_item(e,function(){table.data=$.grep(table.data,function(t){return t.id!==e}),table.renderData()})}})}).on("click",".btn_edit",function(){var e=$(this).closest("tr").data("data-obj").id;box_docking.initHeader("修改接口"),box_docking.initContent("http://es2.laizhuan.com/back/page/docking_add .docking_form",function(){renderForm(e),$(".docking_edit").prepend($('<input name="id" type="hidden" value="'+e+'">')),box_docking.show()})}).on("click",".btn_renew",function(){var e=$(this).closest("tr").data("data-obj").id;box_docking.initHeader("续单接口"),box_docking.initContent("http://es2.laizhuan.com/back/page/docking_add .docking_form",function(){renderForm(e),box_docking.show()})}).on("click",".btn_search",function(){var e=$(this).closest("tr").data("data-obj").id;box_docking.initHeader("查看详情"),box_docking.initContent("http://es2.laizhuan.com/back/page/docking_add .docking_form",function(){renderForm(e),$(".docking_edit").addClass("readonly"),$(".docking_edit :input").prop("disabled",!0),box_docking.show()})}).on("click",".add_docking",function(){box_docking.initHeader("添加接口"),box_docking.initContent("http://es2.laizhuan.com/back/page/docking_add .docking_form",function(){$(".source_ct").suggest({key:"id",val:"name",$key_ct:$('[name="source"]'),$val_ct:$(".source_name"),data:source_data}),base.requireChild($(".docking_edit")),$(".icon_plus").trigger("click","insert"),box_docking.show()})}).on("click",".icon_test",function(){var e=$(this).closest("tr").data("data-obj"),t=$(this).attr("data-type");testDocking(e.id,t,$(this).closest("td"))}),$("body").on("click",".docking_content .icon_plus",function(e,t){var a,n=$(this).closest(".docking_content");n.is(".unique_docking_content")?a="unique":n.is(".click_docking_content")?a="click":n.is(".active_docking_content")&&(a="active");var i=$(this).data("data-index")||0,o=0===i&&"unique"!==a&&"insert"===t?" disabled ":" ",c=$('<li class="param_item"><div class="grid"><div class="ct_5-2 grid_nowrap"><div class="ct_3 field field_first">参数</div><div class="ct_3-2"><select'+o+'><option value="system" data-show="#'+a+"_system_val_"+i+'">系统值</option><option value="preset" data-show="#'+a+"_preset_val_"+i+'">预设值</option></select></div></div><div class="ct_5-3 grid"><div class="ct_2 grid_nowrap"><div class="ct_3 field">key</div><div class="ct_3-2"><input type="text"'+o+'id="'+a+"_param_key["+i+']" name="'+a+"_param_key["+i+']"></div></div><div class="ct_2 grid_nowrap"><div class="ct_3 field">value</div><div class="ct_3-2"><select id="'+a+"_system_val_"+i+'" name="'+a+"_param_val["+i+']"'+o+'></select><input type="text" disabled class="hidden" id="'+a+"_preset_val_"+i+'" name="'+a+"_param_val["+i+']"></div></div></div><i class="iconfont icon-66d icon_remove"></i></div></li>');$(this).closest(".docking_content").find(".param_items").append(c),base.renderOption($("#"+a+"_system_val_"+i),systemOpts),$(this).data("data-index",++i),base.requireChild(c)}).on("click",".docking_content .icon_remove",function(){var e=this;new Tip({$ct:$(this),content:"确认删除？",confirm:!0,css:{"white-space":"nowrap"},theme:"warning",dir:"left",alertfn:function(t){if(t){var a=$(e).closest(".docking_content");$(e).closest(".param_item").remove(),renderUrl(a)}}})}).on("change",".docking_content select",function(){renderUrl($(this).closest(".docking_content"))}).on("keyup",".docking_content input",function(){renderUrl($(this).closest(".docking_content"))})});