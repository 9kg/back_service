$(function(){function e(){var e=base.calDate("i",-(new Date).getMinutes()),a=base.calDate("y",1,e);r=$(".date_start").val(base.date("y-m-d h:i",e)).datepicker({format:"y-m-d h:i",min:"today",datetime:e}),s=$(".date_end").val(base.date("y-m-d h:i",a)).datepicker({format:"y-m-d h:i",min:"today",datetime:a}),$(".source_id_ct").suggest({key:"id",val:"name",$key_ct:$('[name="source_id"]'),$val_ct:$(".source_name"),data:n})}function a(e,a){var t=$("form.add_task"),i=["storeurl","stime","expire","countall","steptime","id","name"],r=["link","keyword","keywordTop","source_id","iscomment"],s=["price","taskprice"],c=["isDeviceVer"],o=["steptime_acc","isiPhone","isreg","isWifi","isSim","isJailbreak","isIp","isIpcn","isSided","isIdfa"],d=base.date("y-m-d "),m=base.date("y-m-d ",base.calDate("y",1,new Date));$.each(i,function(i,n){!a||"stime"!==n&&"expire"!==n?$('[name="'+n+'"]',t).val(e[n]):("stime"===n&&$('[name="'+n+'"]',t).val(e[n]?d+e[n].split(" ")[1]:""),"expire"===n&&$('[name="'+n+'"]',t).val(e[n]?m+e[n].split(" ")[1]:""))}),$.each(r,function(a,i){var r=e[i]&&"0"!==e[i];$(".ct_"+i,t).prop("checked",r).trigger("change"),r&&($('[name="'+i+'"]',t).val(e[i]),"source_id"===i&&$(".source_name").val(n[e[i]]))}),$.each(s,function(a,i){var n=$('[name="'+i+'"][value="'+e[i]+'"]',t);n.length?n.prop("checked",!0):($(".ct_"+i,t).prop("checked",!0).trigger("change"),$('[type="text"][name="'+i+'"]',t).val(e[i]))}),$.each(c,function(a,i){$('[name="'+i+'"][value="'+e[i]+'"]',t).prop("checked",!0)}),$.each(o,function(a,i){$('[name="'+i+'"]',t).prop("checked","1"===e[i])})}function t(e){var a=$("form.add_task");if(!base.formValidate(a))return!1;$('[name="price"][data-show]:checked,[name="taskprice"][data-show]:checked').prop("disabled",!0);var t=a.serializeArray(),i=oper_task.box.operType;return $.ajax({url:"http://es2.laizhuan.com/back/task/"+i,type:"POST",dataType:"json",data:t}).done(function(t){1==t.status?(e&&e(!0,t&&t.msg),"insert"===i&&window.open("http://es2.laizhuan.com/back/page/task_detail/"+t.data)):2==t.status&&(oper_task&&oper_task.box&&oper_task.box.show(),a.find('[name="storeurl"]').focus().parent().operTip(t&&t.msg||"任务链接错误!",{theme:"danger",dir:"bottom",css:{"white-space":"nowrap"}}))}).fail(function(a){e&&e(),console.dir(a)}),!0}function i(){var i=new Box({title:"添加特邀用户",html:"http://es2.laizhuan.com/back/page/task_add .add_task_form",css:{"min-width":"320px"},fnSure:function(e,a){return t(e&&e.afterfnSure)?void 0:!1},fnCancel:function(e){}});window.oper_task={box:i,initWidget:e,source_data:n,renderTaskForm:a}}var n={};$.ajax({url:"http://es2.laizhuan.com/back/source/query",dataType:"json"}).done(function(e){1==e.status&&$.each(e.data,function(e,a){n[a.id]=a.name})});var r,s;$(".date_start").length?(e(),$('form.add_task [name="storeurl"]').attr("data-validate-dir","")):i(),$(".source_id_ct").suggest({key:"id",val:"name",$key_ct:$('[name="source_id"]'),$val_ct:$(".source_name"),url:"http://es2.laizhuan.com/back/source/query"}),$("body").on("change",".date_start,.date_end",function(){$(this).is(".date_start")?s.cgOpt({min:$(this).val()}):r.cgOpt({max:$(this).val()})}).on("click",".btn_task_submit",function(){t(function(e){})})});