$(function(){var t,e,a=base.calDate("d",-30,new Date),n=$(".date_start").val(base.date("y-m-d",a)).datepicker({timepicker:!1,max:"today",min:"2016-07-20",datetime:a}),s=$(".date_end").val(base.now("y-m-d")).datepicker({timepicker:!1,min:a,max:"today"}),d=new Box({title:"申请打款",html:"http://es2.laizhuan.com/back/page/adver_cashed_add .adver_cashed_form",css:{"min-width":"320px","max-width":"420px"},fnSure:function(t,a){var n=$("form.adver_cashed");if(!base.formValidate(n))return!1;var s=n.serializeArray();$.ajax({url:"http://es2.laizhuan.com/back/finance/adver_cash_update",dataType:"json",data:s}).done(function(t){1==t.status?(e.operTip(t.msg||"操作成功!",{theme:"success",dir:"left",css:{"white-space":"nowrap"}}),setTimeout(function(){renderTable()},1e3)):e.operTip(t.msg||"操作失败!",{theme:"danger",dir:"left",css:{"white-space":"nowrap"}})}).fail(function(t){e.operTip("操作失败!",{theme:"danger",dir:"left",css:{"white-space":"nowrap"}})})},fnCancel:function(t){}}),i={$ct:$(".content"),col:[{key:"name",title:"广告主",cls:"hidden_xs",sort:!0,filter:!0},{key:"time",title:"时间",cls:"hidden_xs",sort:!0,filter:!0},{key:"fee",title:"收入/支出",sort:!0,filter:!0},{key:"dsrp",title:"明细",sort:!0,filter:!0},{key:"oper_role",title:"操作人",sort:!0,cls:"hidden_xs"},{key:"status",title:"状态",sort:!0,cls:"hidden_xs",render:function(t,e){t.html(['<span class="label_danger">已拒绝</span>','<span class="label_warning">待审核</span>','<span class="label_success">已同意</span>'][+e+1])}},{key:"id",title:"操作",width:60,cls:"t_center",render:function(t,e,a,n){var s="";2===role?(s='<button type="button" class="btn" data-id="'+e+'">确认</button><button type="button" class="btn" data-id="'+e+'">拒绝</button>',0==n.status&&(s='<button type="button" class="btn btn_success btn_confirm" data-id="'+e+'">确认</button><button type="button" class="btn btn_danger btn_refuse" data-id="'+e+'">拒绝</button>')):(s='<button type="button" class="btn" data-id="'+e+'">修改</button>',0==n.status&&n.oper_role==user_id&&(s='<button type="button" class="btn btn_warning btn_modify" data-id="'+e+'">修改</button>')),t.append($(s)).data("cur_data",n)}}],isLocal:!0,url:"http://es2.laizhuan.com/back/finance/adver_cash",sendData:{sdate:$(".date_start").val(),edate:$(".date_end").val()},fnAfterData:function(e){t=e&&e.data},fnAfterRender:function(){$(".filter_status").eq(1).trigger("click")}};window.renderTable=function(){r.data=null,r.render()};var r=new Table(i);$("body").on("click","table .btn_confirm, table .btn_refuse",function(){var t=$(this).parent(),e=$(this).data("id"),a=$(this).is(".btn_confirm")?1:-1;$.ajax({url:"http://es2.laizhuan.com/back/finance/adver_cash_confirm",dataType:"json",data:{id:e,status:a}}).done(function(e){1==e.status?(t.operTip(e.msg||"操作成功!",{theme:"success",dir:"left",css:{"white-space":"nowrap"}}),setTimeout(renderTable,1e3)):t.operTip(e.msg||"操作失败!",{theme:"danger",dir:"left",css:{"white-space":"nowrap"}})}).fail(function(e){t.operTip("操作失败!",{theme:"danger",dir:"left",css:{"white-space":"nowrap"}})})}).on("click","table .btn_modify",function(){e=$(this).parent();var t=$(this).data("id"),a=$(this).parent().data("cur_data");console.dir(a),d.initContent("http://es2.laizhuan.com/back/page/adver_cashed_add .adver_cashed_form",function(){var e=$("form.adver_cashed");e.prepend($('<input type="hidden" name="id" value="'+t+'"/>')),e.find('[name="price_all"]').val(a.fee),e.find('[name="descripe"]').val(a.dsrp),d.show()})}).on("change",".date_start",function(){s.cgOpt({min:$(this).val()}),r.sendData.sdate=$(".date_start").val(),renderTable()}).on("change",".date_end",function(){n.cgOpt({max:$(this).val()}),r.sendData.edate=$(".date_end").val(),renderTable()}).on("click",".filter_status",function(){if(!t)return!1;var e=$(".filter_status:checked").val();0!=e?r.col[r.col.length-1].show=!1:r.col[r.col.length-1].show=!0,r.data=$.map(t,function(t){return t.status==e?t:void 0}),r.render()})});